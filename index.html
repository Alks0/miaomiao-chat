<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Web Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="libs/marked-highlight/index.css">
</head>
<body>
    <!-- 会话侧边栏 -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-resize-handle"
             id="sidebar-resize-handle"
             title="拖拽调整侧边栏宽度"
             role="separator"
             aria-label="侧边栏宽度调整手柄"
             aria-valuenow="280"
             aria-valuemin="240"
             aria-valuemax="500"
             aria-orientation="vertical"
             tabindex="0"></div>
        <div class="sidebar-header">
            <h2>会话列表</h2>
            <div class="sidebar-header-actions">
                <button id="new-session-btn" class="new-session-btn" title="新建会话" aria-label="创建新的聊天会话">
                    <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    新建
                </button>
                <button id="close-sidebar" class="close-sidebar-btn" title="关闭" aria-label="关闭会话列表">
                    <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 会话搜索栏 -->
        <div class="session-search-bar">
            <svg class="search-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" id="session-search-input" placeholder="搜索会话消息..." autocomplete="off" aria-label="搜索会话" />
            <button class="search-clear-btn" id="session-search-clear" style="display: none;" title="清除搜索" aria-label="清除搜索">
                <svg aria-hidden="true" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <div id="session-list" class="session-list">
            <!-- 会话列表将通过JS动态填充 -->
        </div>
        <div id="background-tasks-indicator" class="background-tasks-indicator" style="display: none;">
            <!-- 后台任务指示器 -->
        </div>
    </aside>

    <!-- 侧边栏遮罩 -->
    <button class="sidebar-overlay" aria-label="关闭侧边栏" tabindex="-1"></button>

    <!-- 设置面板 -->
    <aside id="settings-panel" class="settings-panel">
        <div class="settings-panel-resize-handle"
             id="settings-resize-handle"
             title="拖拽调整面板宽度"
             role="separator"
             aria-label="设置面板宽度调整手柄"
             aria-valuenow="320"
             aria-valuemin="280"
             aria-valuemax="600"
             aria-orientation="vertical"
             tabindex="0"></div>
        <div class="settings-header">
            <h2>设置</h2>
            <button id="close-settings" class="close-settings-btn" title="关闭" aria-label="关闭设置面板">
                <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="settings-content">
            <!-- 模型选择 -->
            <div class="settings-group">
                <label class="settings-label">模型</label>
                <div class="settings-row">
                    <select id="model-select" class="settings-select" aria-label="选择AI模型">
                        <option value="gemini-3-pro-image-preview">gemini-3-pro-image-preview</option>
                        <option value="gemini-3-pro-image-preview-2k" selected>gemini-3-pro-image-preview-2k</option>
                        <option value="gemini-3-pro-image-preview-4k">gemini-3-pro-image-preview-4k</option>
                    </select>
                </div>
            </div>

            <!-- OpenAI 模型参数 -->
            <div class="settings-group api-config" id="openai-config">
                <details class="model-params-details">
                    <summary class="model-params-summary">模型参数 <span class="hint">(留空使用默认值)</span></summary>
                    <div class="model-params-grid">
                        <div class="param-item">
                            <label for="openai-temperature">Temperature</label>
                            <input type="number" id="openai-temperature" step="0.1" min="0" max="2" placeholder="0-2">
                        </div>
                        <div class="param-item">
                            <label for="openai-max-tokens">Max Tokens</label>
                            <input type="number" id="openai-max-tokens" min="1" placeholder="最大输出">
                        </div>
                        <div class="param-item">
                            <label for="openai-top-p">Top P</label>
                            <input type="number" id="openai-top-p" step="0.1" min="0" max="1" placeholder="0-1">
                        </div>
                        <div class="param-item">
                            <label for="openai-frequency-penalty">Frequency Penalty</label>
                            <input type="number" id="openai-frequency-penalty" step="0.1" min="-2" max="2" placeholder="-2 到 2">
                        </div>
                        <div class="param-item">
                            <label for="openai-presence-penalty">Presence Penalty</label>
                            <input type="number" id="openai-presence-penalty" step="0.1" min="-2" max="2" placeholder="-2 到 2">
                        </div>
                    </div>
                </details>
            </div>

            <!-- Gemini 配置 -->
            <div class="settings-group api-config" id="gemini-config">
                <label class="settings-label">图片尺寸</label>
                <select id="image-size-select" class="settings-select" title="图片生成尺寸" aria-label="选择图片生成尺寸">
                    <option value="">无</option>
                    <option value="2K">2K</option>
                    <option value="4K">4K</option>
                </select>
                <!-- Gemini 模型参数 -->
                <details class="model-params-details">
                    <summary class="model-params-summary">模型参数 <span class="hint">(留空使用默认值)</span></summary>
                    <div class="model-params-grid">
                        <div class="param-item">
                            <label for="gemini-temperature">Temperature</label>
                            <input type="number" id="gemini-temperature" step="0.1" min="0" max="2" placeholder="0-2">
                        </div>
                        <div class="param-item">
                            <label for="gemini-max-output-tokens">Max Output Tokens</label>
                            <input type="number" id="gemini-max-output-tokens" min="1" placeholder="最大输出">
                        </div>
                        <div class="param-item">
                            <label for="gemini-top-p">Top P</label>
                            <input type="number" id="gemini-top-p" step="0.1" min="0" max="1" placeholder="0-1">
                        </div>
                        <div class="param-item">
                            <label for="gemini-top-k">Top K</label>
                            <input type="number" id="gemini-top-k" min="1" max="100" placeholder="1-100">
                        </div>
                    </div>
                </details>

                <!-- Gemini System Parts -->
                <details class="model-params-details">
                    <summary class="model-params-summary">System Instruction Parts <span class="hint">(多段系统提示)</span></summary>
                    <div class="gemini-system-parts-manager">
                        <div id="gemini-system-parts-list" class="system-parts-list">
                            <!-- 动态填充 -->
                        </div>
                        <div class="system-parts-controls">
                            <textarea id="gemini-system-part-input" class="settings-input" placeholder="输入 System Instruction Part 内容..." rows="3"></textarea>
                            <button id="add-gemini-system-part" class="settings-icon-btn" title="添加 System Part">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="settings-hint">Gemini 的 systemInstruction 可包含多个 parts，按顺序处理</p>
                </details>
            </div>

            <!-- 旧版配置 (隐藏，保持兼容) -->
            <input type="hidden" id="api-endpoint" value="http://localhost:8000/v1/chat/completions">
            <input type="hidden" id="api-key" value="">

            <!-- 流式输出开关 -->
            <div class="settings-group">
                <label class="settings-label">响应模式</label>
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="stream-enabled" checked>
                        <span class="slider"></span>
                    </label>
                    <span>流式输出</span>
                </div>
                <p class="settings-hint">关闭后将等待完整响应再显示</p>
            </div>

            <!-- 思维链开关 -->
            <div class="settings-group" id="thinking-config">
                <label class="settings-label">思维链</label>
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="thinking-enabled">
                        <span class="slider"></span>
                    </label>
                    <span>启用思考过程</span>
                </div>
                <div class="thinking-strength" id="thinking-strength-group" style="display: none;">
                    <button class="strength-btn" data-strength="low" title="快速思考，约 1K tokens 预算">低</button>
                    <button class="strength-btn" data-strength="medium" title="平衡模式，约 8K tokens 预算">中</button>
                    <button class="strength-btn active" data-strength="high" title="深度思考，约 32K tokens 预算">高</button>
                    <button class="strength-btn" data-strength="custom" title="自定义 token 预算">自定义</button>
                </div>
                <div class="thinking-budget-input" id="thinking-budget-group" style="display: none;">
                    <label for="thinking-budget">Token 预算:</label>
                    <input type="number" id="thinking-budget" min="1024" max="131072" step="1024" value="32768"
                           placeholder="输入 token 数量">
                    <span class="budget-hint">范围: 1K - 128K</span>
                </div>
                <p class="settings-hint" id="thinking-hint" style="display: none;">
                    深度思考会增加响应时间和 token 消耗，但推理质量更高
                </p>

                <!-- ⭐ 新增：思维链 None 模式 -->
                <div class="toggle-row" style="margin-top: 12px;">
                    <label class="switch">
                        <input type="checkbox" id="thinking-none-mode">
                        <span class="slider"></span>
                    </label>
                    <span>关闭时发送 None（Responses API 模式）</span>
                </div>
                <p class="settings-hint">开启后，关闭思维链会发送 reasoning.effort=none 而非不传参数</p>
            </div>

            <!-- ⭐ 新增：输出详细度控制 -->
            <div class="settings-group">
                <label class="settings-label">输出详细度</label>
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="verbosity-enabled">
                        <span class="slider"></span>
                    </label>
                    <span>启用详细度控制</span>
                </div>
                <div id="verbosity-select-group" style="display: none; margin-top: 12px;">
                    <select id="output-verbosity" class="settings-select">
                        <option value="low">低（简洁）</option>
                        <option value="medium" selected>中（平衡）</option>
                        <option value="high">高（详细）</option>
                    </select>
                </div>
                <p class="settings-hint">开启后发送 text.verbosity 参数（所有格式都发送，由 API 自行判断是否支持）</p>
            </div>

            <!-- 网络搜索开关 -->
            <div class="settings-group">
                <label class="settings-label">网络搜索</label>
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="web-search-enabled">
                        <span class="slider"></span>
                    </label>
                    <span>启用实时搜索</span>
                </div>
                <p class="settings-hint">允许 AI 搜索互联网获取最新信息</p>
            </div>

            <!-- 回复数量 -->
            <div class="settings-group">
                <label class="settings-label">回复数量</label>
                <select id="reply-count-select" class="settings-select" title="一次生成几个回复" aria-label="选择一次生成的回复数量">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>

            <!-- 隐藏旧的 Gemini 图片配置，已移入 gemini-config -->
            <div class="settings-group" id="gemini-image-config" style="display: none;"></div>

            <!-- 预填充消息配置 -->
            <div class="settings-group">
                <label class="settings-label">预填充消息</label>
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="prefill-enabled" checked>
                        <span class="slider"></span>
                    </label>
                    <span>启用预填充</span>
                </div>
            </div>

            <div class="settings-group prefill-config" id="prefill-config">
                <!-- 预设管理 -->
                <div class="prefill-preset-row">
                    <select id="prefill-preset-select" class="settings-select">
                        <option value="">-- 自定义 --</option>
                    </select>
                    <button id="save-prefill-preset" class="settings-icon-btn" title="保存预设">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                    </button>
                    <button id="delete-prefill-preset" class="settings-icon-btn danger" title="删除预设">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>

                <!-- 变量设置 -->
                <div class="prefill-vars-row">
                    <div class="var-input">
                        <label>{{char}}</label>
                        <input type="text" id="char-name" value="Assistant" placeholder="角色名">
                    </div>
                    <div class="var-input">
                        <label>{{user}}</label>
                        <input type="text" id="user-name" value="User" placeholder="用户名">
                    </div>
                </div>

                <!-- System Prompt -->
                <label class="prefill-label">System Prompt</label>
                <textarea
                    id="system-prompt-input"
                    class="prefill-textarea"
                    placeholder="系统指令...&#10;支持变量: {{char}}, {{user}}, {{date}}, {{time}}"
                    rows="4"
                ></textarea>

                <!-- 动态消息列表 -->
                <label class="prefill-label">预填充对话</label>
                <div id="prefill-messages-list" class="prefill-messages-list">
                    <!-- 动态生成 -->
                </div>
                <button id="add-prefill-message" class="prefill-add-btn">+ 添加消息</button>

                <p class="settings-hint">
                    变量: {{char}}=角色名, {{user}}=用户名, {{date}}=日期, {{time}}=时间
                </p>
            </div>

            <!-- 自定义请求头 -->
            <div class="settings-group">
                <label class="settings-label">自定义请求头</label>
                <div id="custom-headers-list" class="custom-headers-list">
                    <!-- 动态填充 -->
                </div>
                <button id="add-custom-header" class="add-header-btn" title="添加请求头">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    添加请求头
                </button>
                <p class="settings-hint">添加自定义 HTTP 请求头，如 X-Auth-Token</p>
            </div>

            <!-- 配置管理 -->
            <div class="settings-group">
                <label class="settings-label">配置管理</label>
                <div class="config-manager">
                    <select id="config-select" class="settings-select" title="选择配置" aria-label="选择保存的配置">
                        <option value="">-- 选择配置 --</option>
                    </select>
                    <button id="save-config" class="settings-icon-btn" title="保存当前配置" aria-label="保存当前设置为新配置">
                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                    </button>
                    <button id="delete-config" class="settings-icon-btn delete" title="删除当前配置" aria-label="删除选中的配置">
                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- 应用更新设置 (仅 Electron/APK 显示) -->
            <div class="settings-group" id="update-settings" style="display: none;">
                <label class="settings-label">应用更新</label>

                <!-- 启动时检查更新 -->
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="check-update-startup" checked>
                        <span class="slider"></span>
                    </label>
                    <span>启动时检查更新</span>
                </div>

                <!-- 默认静默更新 -->
                <div class="toggle-row">
                    <label class="switch">
                        <input type="checkbox" id="default-silent-update">
                        <span class="slider"></span>
                    </label>
                    <span>默认静默更新</span>
                </div>
                <p class="settings-hint">启用后发现新版本将自动后台下载，下次启动时安装</p>

                <!-- 立即检查更新按钮 -->
                <div class="settings-row" style="margin-top: 12px;">
                    <button id="manual-check-update-btn" class="settings-button" style="width: 100%; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        立即检查更新
                    </button>
                </div>

                <!-- 当前版本号 -->
                <p class="settings-hint" id="current-version-display" style="margin-top: 8px; text-align: center; font-size: 12px; opacity: 0.7;">
                    当前版本：<span id="current-version-number">1.0.0</span>
                </p>
            </div>

            <!-- 数据导出导入 -->
            <div class="settings-group">
                <label class="settings-label">数据备份</label>
                <div class="export-import-controls">
                    <button id="export-config" class="export-import-btn" title="导出配置">
                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                        </svg>
                        导出配置
                    </button>
                    <button id="export-sessions" class="export-import-btn" title="导出会话">
                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                        </svg>
                        导出会话
                    </button>
                    <button id="export-all" class="export-import-btn" title="导出所有数据">
                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                        </svg>
                        全部导出
                    </button>
                    <button id="import-data" class="export-import-btn import" title="导入数据">
                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                        </svg>
                        导入数据
                    </button>
                </div>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <p class="settings-hint">导出配置、会话记录或完整备份，支持导入恢复</p>
            </div>
        </div>
    </aside>

    <!-- 设置面板遮罩 -->
    <button class="settings-overlay" aria-label="关闭设置面板" tabindex="-1"></button>

    <!-- 更新弹窗 -->
    <div class="update-modal-overlay" id="update-modal-overlay" style="display: none;">
        <div class="update-modal">
            <!-- 关闭按钮 -->
            <button class="update-modal-close" id="update-modal-close" aria-label="关闭更新提示">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>

            <!-- 图标 -->
            <div class="update-modal-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
            </div>

            <!-- 内容 -->
            <h2 class="update-modal-title">发现新版本</h2>
            <p class="update-modal-version" id="update-modal-version">v1.0.1</p>
            <p class="update-modal-description" id="update-modal-description">
                建议您更新到最新版本以获得更好的体验
            </p>

            <!-- 按钮组 -->
            <div class="update-modal-actions">
                <button class="update-btn update-btn-primary" id="update-now-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    立刻更新
                </button>
                <button class="update-btn update-btn-secondary" id="update-silent-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    静默更新
                </button>
            </div>

            <!-- 进度条（下载时显示） -->
            <div class="update-progress-container" id="update-progress-container" style="display: none;">
                <div class="update-progress-bar">
                    <div class="update-progress-fill" id="update-progress-fill" style="width: 0%"></div>
                </div>
                <p class="update-progress-text" id="update-progress-text">正在下载... 0%</p>
            </div>
        </div>
    </div>

    <!-- 像素装饰元素 -->
    <div class="pixel-decorations">
        <!-- 星星 -->
        <div class="pixel-star"></div>
        <div class="pixel-star"></div>
        <div class="pixel-star"></div>
        <div class="pixel-star"></div>
        <div class="pixel-star"></div>
        <!-- 云朵 -->
        <div class="pixel-cloud"></div>
        <div class="pixel-cloud"></div>
        <div class="pixel-cloud"></div>
        <!-- 心形 -->
        <div class="pixel-heart"></div>
        <div class="pixel-heart"></div>
        <!-- 钻石 -->
        <div class="pixel-diamond"></div>
        <div class="pixel-diamond"></div>
        <div class="pixel-diamond"></div>
        <!-- 圆点组 -->
        <div class="pixel-dots">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </div>
        <div class="pixel-dots">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </div>
        <div class="pixel-dots">
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
            <span></span><span></span><span></span>
        </div>
    </div>

    <div class="app-container">
        <!-- 顶部栏 -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <button id="sidebar-toggle" class="icon-button" title="会话列表" aria-label="打开会话列表">
                        <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12h18M3 6h18M3 18h18"/>
                        </svg>
                    </button>
                    <h1 class="app-title">Web Chat</h1>
                </div>
                <div class="header-actions">
                    <button id="providers-toggle" class="icon-button" title="提供商管理" aria-label="管理 API 提供商">
                        <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                    </button>
                    <button id="theme-toggle" class="icon-button" title="切换主题" aria-label="切换亮色/暗色主题">
                        <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </button>
                    <button id="clear-chat" class="icon-button" title="清空对话" aria-label="清空当前对话">
                        <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- 聊天容器 -->
        <main class="chat-container">
            <div id="messages" class="messages-area">
                <!-- 欢迎消息 -->
                <div class="welcome-message glass">
                    <div class="gemini-logo">
                        <svg width="64" height="64" viewBox="0 0 64 64">
                            <defs>
                                <linearGradient id="gemini-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#9168c0"/>
                                    <stop offset="100%" style="stop-color:#a8c7fa"/>
                                </linearGradient>
                            </defs>
                            <circle cx="32" cy="32" r="28" fill="url(#gemini-gradient)"/>
                        </svg>
                    </div>
                    <h2>你好，我是 喵喵喵</h2>
                </div>
            </div>
            <!-- 滚动到底部按钮 -->
            <button id="scroll-to-bottom" class="scroll-to-bottom-btn" title="回到底部" aria-label="滚动到最新消息">
                <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14M5 12l7 7 7-7"/>
                </svg>
            </button>
        </main>

        <!-- 简洁输入栏 -->
        <footer class="input-bar">
            <!-- 图片预览区（在输入框上方） -->
            <div id="image-preview-container" class="image-preview-bar"></div>
            <!-- 拖拽调整高度手柄 -->
            <div id="input-resize-handle" class="input-resize-handle" title="拖拽调整输入框高度"></div>
            <div class="input-bar-inner" id="input-bar-inner">
                <span class="char-counter" id="char-counter"></span>
                <button id="attach-file" class="input-icon-btn" title="附加文件" aria-label="上传图片文件">
                    <svg aria-hidden="true" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
                <textarea
                    id="user-input"
                    class="input-textarea"
                    placeholder="输入消息..."
                    rows="1"
                    aria-label="消息输入框"
                ></textarea>
                <button id="save-edit" class="save-edit-btn" title="保存编辑" aria-label="保存编辑的消息" onclick="saveEdit()">
                    <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                </button>
                <button id="cancel-edit" class="cancel-edit-btn" title="取消编辑 (ESC)" aria-label="取消编辑消息" onclick="cancelEdit()">
                    <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
                <button id="settings-toggle" class="input-icon-btn" title="设置" aria-label="打开设置面板">
                    <svg aria-hidden="true" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                </button>
                <button id="send-button" class="send-btn" title="发送" aria-label="发送消息">
                    <svg aria-hidden="true" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
                <!-- 取消请求按钮（仅在请求进行时显示）-->
                <button id="cancel-request-button" class="cancel-btn" style="display: none;" title="取消请求" aria-label="取消当前请求">
                    <svg aria-hidden="true" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </button>
            </div>
            <!-- 快捷开关栏 -->
            <div class="input-quick-toggles">
                <button id="attach-file-mini" class="quick-toggle-btn" title="附加文件">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                    <span>上传</span>
                </button>
                <button id="toggle-stream" class="quick-toggle-btn active" title="流式输出">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <span>流式</span>
                </button>
                <button id="toggle-thinking" class="quick-toggle-btn" title="思维链">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3M12 17h.01"/>
                    </svg>
                    <span>思维链</span>
                </button>
                <button id="toggle-websearch" class="quick-toggle-btn" title="网络搜索">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
                    </svg>
                    <span>联网</span>
                </button>
                <button id="quick-messages-toggle" class="quick-toggle-btn" title="快捷消息">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        <path d="M8 10h8M8 14h4"/>
                    </svg>
                    <span>快捷</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- 图片查看器模态框 -->
    <div id="image-viewer-modal" class="image-viewer-modal" onclick="closeImageViewer(event)">
        <button class="image-viewer-close" onclick="closeImageViewer()">&times;</button>
        <img id="image-viewer-img" src="" alt="查看大图">
    </div>

    <!-- 加载 marked.js 用于 Markdown 渲染 -->
    <script src="libs/marked/marked.min.js"></script>
    <script src="libs/marked-highlight/index.umd.js"></script>
    <script src="libs/highlight/highlight.min.js"></script>
    <script src="libs/highlight/languages/python.min.js"></script>
    <script src="libs/highlight/languages/java.min.js"></script>
    <script src="libs/highlight/languages/cpp.min.js"></script>
    <!-- 加载 KaTeX 用于数学公式渲染 -->
    <link rel="stylesheet" href="libs/katex/katex.min.css">
    <script src="libs/katex/katex.min.js"></script>
    <!-- 加载 DOMPurify 用于 HTML 净化（XSS 防护）-->
    <script src="libs/dompurify/purify.min.js"></script>

    <!-- ========== 快捷消息模态框 ========== -->
    <div id="quick-messages-modal" class="modal" role="dialog" aria-labelledby="quick-messages-modal-title" aria-modal="true">
        <div class="modal-overlay"></div>
        <div class="modal-content quick-messages-modal-content">
            <div class="detail-header">
                <h2 id="quick-messages-modal-title">快捷消息</h2>
                <div class="detail-header-actions">
                    <button id="add-quick-message-btn" class="icon-button" title="新建快捷消息">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                    <button id="close-quick-messages-modal" class="icon-button" title="关闭">×</button>
                </div>
            </div>
            <div class="detail-content">
                <div id="quick-messages-list" class="quick-messages-list"></div>
            </div>
        </div>
    </div>

    <!-- ========== 编辑快捷消息模态框 ========== -->
    <div id="edit-quick-message-modal" class="modal" role="dialog" aria-labelledby="edit-qm-modal-title" aria-modal="true">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="detail-header">
                <h2 id="edit-qm-modal-title">新建快捷消息</h2>
                <button id="close-edit-qm-modal" class="icon-button">×</button>
            </div>
            <div class="detail-content">
                <div class="form-group">
                    <label for="qm-name-input">名称</label>
                    <input type="text" id="qm-name-input" maxlength="50" placeholder="快捷消息名称">
                </div>
                <div class="form-group">
                    <label for="qm-content-input">内容</label>
                    <textarea id="qm-content-input" rows="6" placeholder="快捷消息内容"></textarea>
                </div>
                <div class="form-group">
                    <label for="qm-category-input">分类（可选）</label>
                    <select id="qm-category-input" class="settings-select">
                        <option value="常用">常用</option>
                        <option value="问候">问候</option>
                        <option value="告别">告别</option>
                    </select>
                </div>
            </div>
            <div class="detail-footer">
                <button id="cancel-edit-qm-btn" class="btn-secondary">取消</button>
                <button id="save-qm-btn" class="btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- ========== 提供商管理模态框 ========== -->
    <!-- ========== 提供商管理模态框（左右分栏） ========== -->
    <div id="providers-modal" class="modal" role="dialog" aria-labelledby="providers-modal-title" aria-modal="true">
        <div class="modal-overlay"></div>
        <div class="modal-content providers-modal-content">
            <!-- 左侧：提供商列表 -->
            <div class="providers-sidebar">
                <!-- 搜索栏 -->
                <div class="providers-search">
                    <input type="text" id="providers-search-input" placeholder="搜索提供商..." />
                </div>

                <!-- 提供商列表 -->
                <div class="providers-list" id="providers-list">
                    <!-- 动态生成 -->
                </div>

                <!-- 添加按钮 -->
                <button id="add-provider-btn" class="add-provider-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14m-7-7h14"/>
                    </svg>
                    添加提供商
                </button>
            </div>

            <!-- 右侧：提供商详情 -->
            <div class="providers-detail">
                <div class="detail-header">
                    <h2 id="providers-modal-title">提供商配置</h2>
                    <button id="close-providers-modal" class="icon-button" aria-label="关闭">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="detail-content" id="provider-detail-content">
                    <!-- 空状态或表单 -->
                    <div class="empty-detail">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                        <p>选择或添加一个提供商</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 模型管理模态框（第三层） ========== -->
    <div id="models-manage-modal" class="modal" role="dialog" aria-labelledby="models-manage-title" aria-modal="true">
        <div class="modal-overlay"></div>
        <div class="modal-content models-manage-content">
            <div class="modal-header">
                <h2 id="models-manage-title">从 API 添加模型</h2>
                <button id="close-models-manage" class="icon-button" aria-label="关闭">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- 搜索框 -->
            <div class="models-search">
                <input type="text" id="models-search-input" placeholder="🔍 搜索模型..." />
            </div>

            <!-- 全选/反选按钮 -->
            <div class="models-bulk-actions" id="models-bulk-actions" style="display: none;">
                <button type="button" id="select-all-models" class="btn-bulk-action">
                    ✓ 全选
                </button>
                <button type="button" id="deselect-all-models" class="btn-bulk-action">
                    ✗ 反选
                </button>
            </div>

            <!-- 加载状态 -->
            <div id="models-loading" class="models-loading" style="display: none;">
                <svg class="loading-spinner" width="40" height="40" viewBox="0 0 50 50">
                    <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-dasharray="80" stroke-dashoffset="60"></circle>
                </svg>
                <p>正在拉取模型列表...</p>
            </div>

            <!-- 模型复选框列表 -->
            <div class="models-checklist" id="models-checklist">
                <!-- 动态生成 -->
            </div>

            <!-- 底部按钮 -->
            <div class="modal-footer">
                <button type="button" id="cancel-models-manage" class="btn-secondary">取消</button>
                <button type="button" id="add-selected-models" class="btn-primary">
                    添加选中的模型 (<span id="selected-models-count">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- 模型编辑弹窗 -->
    <div id="edit-model-modal" class="modal" role="dialog" aria-labelledby="edit-model-title" aria-modal="true">
        <div class="modal-overlay"></div>
        <div class="modal-content edit-model-content">
            <div class="modal-header">
                <h2 id="edit-model-title">编辑模型</h2>
                <button id="close-edit-model" class="icon-button" aria-label="关闭">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-model-id">模型 ID</label>
                    <input type="text" id="edit-model-id" readonly class="form-input-readonly" />
                </div>

                <div class="form-group">
                    <label for="edit-model-name">显示名称</label>
                    <input type="text" id="edit-model-name" class="form-input" placeholder="例如: GPT-4 Omni" />
                </div>

                <div class="form-group">
                    <label class="form-section-label">模型能力</label>
                    <p class="form-hint">选择此模型支持的能力（会影响消息过滤）</p>

                    <div class="capability-toggles">
                        <label class="capability-item">
                            <input type="checkbox" id="edit-model-image-input" />
                            <span class="capability-label">图片理解 (Vision)</span>
                            <p class="capability-desc">模型可以理解和分析用户上传的图片</p>
                        </label>

                        <label class="capability-item">
                            <input type="checkbox" id="edit-model-image-output" />
                            <span class="capability-label">图片生成</span>
                            <p class="capability-desc">模型可以在回复中生成图片</p>
                        </label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="cancel-edit-model" class="btn-secondary">取消</button>
                <button type="button" id="save-edit-model" class="btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 通用输入对话框 -->
    <div id="input-dialog-modal" class="modal" role="dialog" aria-modal="true" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="input-dialog-title">输入</h2>
                <button id="close-input-dialog" class="icon-button" aria-label="关闭">×</button>
            </div>
            <div class="modal-body">
                <p id="input-dialog-message" style="margin-bottom: 12px;"></p>
                <input type="text" id="input-dialog-input" class="text-input" style="width: 100%;" />
            </div>
            <div class="modal-footer">
                <button type="button" id="input-dialog-cancel" class="btn-secondary">取消</button>
                <button type="button" id="input-dialog-confirm" class="btn-primary">确定</button>
            </div>
        </div>
    </div>

    <!-- 通用确认对话框 -->
    <div id="confirm-dialog-modal" class="modal" role="dialog" aria-modal="true" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirm-dialog-title">确认</h2>
                <button id="close-confirm-dialog" class="icon-button" aria-label="关闭">×</button>
            </div>
            <div class="modal-body">
                <p id="confirm-dialog-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirm-dialog-cancel" class="btn-secondary">取消</button>
                <button type="button" id="confirm-dialog-confirm" class="btn-primary">确定</button>
            </div>
        </div>
    </div>

    <!-- ========== Modular Version ========== -->
    <script type="module" src="js/main.js"></script>
    <!-- ========== Original Monolithic Version (Backup) ========== -->
    <!-- <script src="app.js"></script> -->
</body>
</html>
